<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›°SAT Predict</title>
    <style>
        .custom-dropdown {
            position: relative;
            width: 200px;
            font-family: Arial, sans-serif;
        }
        .custom-dropdown button {
            width: 100%;
            height: 30px;
            text-align: left;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
        }
        .dropdown-list {
            display: none;
            position: absolute;
            top: 35px;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown-list div {
            padding: 5px;
            cursor: pointer;
        }
        .dropdown-list div:hover {
            background-color: #f1f1f1;
        }
        #searchInput {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }


                /* 19:00~07:00 (å¤œé—´) */
        .night {
            background-color: #494953;
            color: #ffffbc;
        }

        /* å…¶ä½™æ—¶é—´ (ç™½å¤©) */
        .day {
            background-color: #69a7ff;
            color: #ffffff;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #location {
            margin-top: 10px;
        }
        select {
            margin-top: 10px;
            width: 200px;
            height: 30px;
        }
        button {
            margin-top: 10px;
            padding: 10px;
        }
        #satelliteDropdown {
            display: block;
            margin-top: 10px;
        }
        #satelliteDropdown option {
            padding: 10px;
        }

        
    </style>
</head>
<body>
    <button id="getLocation">è·å–ä½ç½®</button>
    <div id="location">ç»çº¬åº¦ï¼šæœªè·å–</div>
    <input type="text" id="searchInput" placeholder="æœç´¢å«æ˜Ÿ..." />
    
    <div class="custom-dropdown">
        <button id="dropdownButton">é€‰æ‹©å«æ˜Ÿ</button>
        <div class="dropdown-list" id="satelliteDropdown"></div>
    </div>
    
    <label for="timeFilter">ä»…è®¡ç®—19:00~23:59</label>
    <input type="checkbox" id="timeFilter">
    <button id="calculatePass">è®¡ç®—è¿‡å¢ƒä¿¡æ¯</button>
    <div id="passInfo">è¿‡å¢ƒä¿¡æ¯ï¼šæœªè®¡ç®—</div>
    <div id="satelliteLinkContainer"></div>

    <script src="satellite.js"></script>

    <script>
        let satellites = [];
        document.getElementById('getLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    document.getElementById('location').textContent = `ç»çº¬åº¦ï¼š${latitude}, ${longitude}`;
                }, function(error) {
                    document.getElementById('location').textContent = 'æ— æ³•è·å–ä½ç½®ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚';
                });
            } else {
                document.getElementById('location').textContent = 'æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½ã€‚';
            }
        });

        window.addEventListener('load', function() {
            fetch('https://c0rs.xanyi.eu.org/?https://r4uab.ru/satonline.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
                    }
                    return response.text();
                })
                .then(data => {
                    satellites = parseSatellitesData(data);
                    localStorage.setItem('satellites', JSON.stringify(satellites));
                    populateDropdown(satellites);
                })
                .catch(error => {
                    console.error('æ— æ³•åŠ è½½æ–‡ä»¶:', error);
                });
        });

function parseSatellitesData(data) {
            const lines = data.split('\n');
            const satellites = [];
            let currentSatellite = null;

            lines.forEach(line => {
                if (line.startsWith('1') || line.startsWith('2')) {
                    if (currentSatellite) {
                        currentSatellite.tle.push(line);
                    }
                } else if (line.trim() !== '') {
                    if (currentSatellite) {
                        satellites.push(currentSatellite);
                    }
                    currentSatellite = { name: line.trim(), tle: [] };
                }
            });

            if (currentSatellite) {
                satellites.push(currentSatellite);
            }

            return satellites;
        }

        function populateDropdown(satellites) {
            const dropdown = document.getElementById('satelliteDropdown');
            satellites.forEach(satellite => {
                const div = document.createElement('div');
                div.textContent = satellite.name;
                div.addEventListener('click', function() {
                    document.getElementById('dropdownButton').textContent = satellite.name;
                    dropdown.style.display = 'none';

                    // Extract NORAD ID (from the first TLE line)
                    const noradId = satellite.tle[1].split(' ')[1]; // TLE line 1, second value is the NORAD ID

                    // Create the "å¯¹æ˜Ÿ" link
                    const satelliteLinkContainer = document.getElementById('satelliteLinkContainer');
                    satelliteLinkContainer.innerHTML = `<a href="https://star.conor.link/find?satelliteId=${noradId}" target="_blank">å½“å‰æ‰€é€‰å«æ˜Ÿå³æ—¶å¯¹æ˜Ÿ</a>`;
                });
                dropdown.appendChild(div);
            });
        }

        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            const dropdown = document.getElementById('satelliteDropdown');
            const options = dropdown.querySelectorAll('div');
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchValue)) {
                    option.style.display = ''; // Show matching options
                } else {
                    option.style.display = 'none'; // Hide non-matching options
                }
            });
        });

        document.getElementById('dropdownButton').addEventListener('click', function() {
            const dropdown = document.getElementById('satelliteDropdown');
            dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
        });

        document.getElementById('calculatePass').addEventListener('click', function() {
            const satelliteName = document.getElementById('dropdownButton').textContent;
            const locationText = document.getElementById('location').textContent;
            const match = locationText.match(/ç»çº¬åº¦ï¼š([\-0-9.]+), ([\-0-9.]+)/);
            const timeFilterChecked = document.getElementById('timeFilter').checked;

            if (satelliteName && match) {
                const latitude = parseFloat(match[1]);
                const longitude = parseFloat(match[2]);
                const altitude = 0;

                const satellites = JSON.parse(localStorage.getItem('satellites'));
                const satelliteinfo = satellites.find(sat => sat.name === satelliteName);

                if (!satelliteinfo) {
                    document.getElementById('passInfo').innerHTML = '<p>æœªæ‰¾åˆ°å«æ˜ŸTLEæ•°æ®ã€‚</p>';
                    return;
                }

                const satrec = satellite.twoline2satrec(satelliteinfo.tle[0], satelliteinfo.tle[1]);
                const currentTime = new Date();
                const passes = calculatePasses(satrec, latitude, longitude, altitude, currentTime, timeFilterChecked);

                const groupedPasses = groupPasses(passes);
                document.getElementById('passInfo').innerHTML = formatGroupedPassesToHTML(groupedPasses);
            } else {
                document.getElementById('passInfo').innerHTML = '<p>è¯·æä¾›å«æ˜Ÿå’Œæœ‰æ•ˆçš„ç»çº¬åº¦ã€‚</p>';
            }
        });

function calculatePasses(satrec, latitude, longitude, altitude, currentTime, filterNightTime) {
    const passes = [];
    const observerGd = {
        latitude: satellite.degreesToRadians(latitude),
        longitude: satellite.degreesToRadians(longitude),
        height: altitude,
    };

    // è®¡ç®—æœªæ¥ 5 å¤©å†…çš„æ‰€æœ‰å¯èƒ½æ—¶é—´ç‚¹
    const endTime = new Date(currentTime.getTime() + 3 * 24 * 60 * 60 * 1000);
    const timeStep = 1 * 1000; // 1åˆ†é’Ÿæ­¥é•¿ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰

    for (let time = currentTime.getTime(); time <= endTime.getTime(); time += timeStep) {
        const passTime = new Date(time);

        // è®¡ç®—å«æ˜Ÿä½ç½®å’Œé€Ÿåº¦
        const positionAndVelocity = satellite.propagate(satrec, passTime);
        if (positionAndVelocity && positionAndVelocity.position) {
            const gmst = satellite.gstime(passTime);

            // è½¬æ¢ä¸ºåœ°ç†åæ ‡å’Œè§†è§’
            const lookAngles = satellite.ecfToLookAngles(
                observerGd,
                satellite.eciToEcf(positionAndVelocity.position, gmst)
            );

            if (lookAngles) {
                const elevationDegrees = satellite.radiansToDegrees(lookAngles.elevation);

                // è¿‡æ»¤ä»°è§’å¤§äºç­‰äº 15 åº¦çš„è®°å½•
                if (elevationDegrees >= 15) {
                    const pass = {
                        time: passTime,
                        azimuth: satellite.radiansToDegrees(lookAngles.azimuth),
                        elevation: elevationDegrees,
                    };

                    // If the checkbox is checked, only include passes between 19:00 and 23:59
                    const passHour = passTime.getHours();
                    if (filterNightTime && (passHour < 19 || passHour >= 24)) {
                        continue; // Skip this pass if it is outside the 19:00 to 23:59 range
                    }

                    passes.push(pass);




                }
            }
        }
    }
    return passes;
}


function groupPasses(passes) {
    const groupedPasses = [];
    let currentPass = null;

    passes.forEach((pass, index) => {
        if (!currentPass) {
            currentPass = { entry: pass, highest: pass, exit: pass };
        } else {
            // å¦‚æœæ—¶é—´è¿ç»­ä¸”ä»°è§’æ»¡è¶³æ¡ä»¶ï¼Œæ›´æ–°å½“å‰è¿‡å¢ƒçš„æœ€é«˜ç‚¹å’Œå‡ºå¢ƒç‚¹
            const timeDifference = (new Date(pass.time) - new Date(currentPass.exit.time)) / 1000;
            if (timeDifference <= 600) { // æ—¶é—´å·®å°äºç­‰äº10åˆ†é’Ÿè®¤ä¸ºæ˜¯åŒä¸€æ¬¡è¿‡å¢ƒ
                currentPass.exit = pass;
                if (parseFloat(pass.elevation) > parseFloat(currentPass.highest.elevation)) {
                    currentPass.highest = pass;
                }
            } else {
                // å®Œæˆä¸€ç»„æ•°æ®åå­˜å‚¨ï¼Œå¹¶å¼€å¯æ–°çš„ä¸€æ¬¡è¿‡å¢ƒ
                groupedPasses.push(currentPass);
                currentPass = { entry: pass, highest: pass, exit: pass };
            }
        }

        // å¦‚æœæ˜¯æœ€åä¸€ä¸ªç‚¹ï¼Œå¼ºåˆ¶ç»“æŸå½“å‰åˆ†ç»„
        if (index === passes.length - 1 && currentPass) {
            groupedPasses.push(currentPass);
        }
    });

    return groupedPasses;
}




function formatGroupedPassesToHTML(groupedPasses) {
    if (groupedPasses.length === 0) {
        return "<p>æœªæ¥5å¤©å†…æ²¡æœ‰ä»°è§’å¤§äºç­‰äº15åº¦çš„è¿‡å¢ƒä¿¡æ¯ã€‚</p>";
    }

    let html = `
        <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>å¼€å§‹</th>
                    <th>æœ€é«˜</th>
                    <th>ç»“æŸ</th>
                </tr>
            </thead>
            <tbody>
    `;

groupedPasses.forEach(pass => {
    const entrydate = pass.entry?.time ? new Date(pass.entry.time).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) : "æœªçŸ¥æ—¶é—´";
    const entryTime = pass.entry?.time ? new Date(pass.entry.time).toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "æœªçŸ¥æ—¶é—´";
    const entryAzimuth = typeof pass.entry?.azimuth === "number" ? `${pass.entry.azimuth.toFixed(2)}Â°` : "æœªçŸ¥";
    
    // Check the time and determine the class for the row
    const entryHour = new Date(pass.entry.time).getHours();
    let rowClass = "";

    if (entryHour >= 19 || entryHour < 7) {
        rowClass = "night";  // 19:00-07:00ï¼Œç°åº•ç™½å­—
    } else {
        rowClass = "day";    // å…¶ä½™æ—¶é—´ï¼Œè“åº•é»„å­—
    }





    const highestTime = pass.highest?.time ? new Date(pass.highest.time).toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "æœªçŸ¥æ—¶é—´";
    const highestAzimuth = typeof pass.highest?.azimuth === "number" ? `${pass.highest.azimuth.toFixed(2)}Â°` : "æœªçŸ¥";
    const highestElevation = typeof pass.highest?.elevation === "number" ? `${pass.highest.elevation.toFixed(2)}Â°` : "æœªçŸ¥";

    const exitTime = pass.exit?.time ? new Date(pass.exit.time).toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "æœªçŸ¥æ—¶é—´";
    const exitAzimuth = typeof pass.exit?.azimuth === "number" ? `${pass.exit.azimuth.toFixed(2)}Â°` : "æœªçŸ¥";

    html += `
        <tr class="${rowClass}">
            <td>${entrydate}</td>
            <td>${entryTime}, ${entryAzimuth}</td>
            <td>${highestTime}, ${highestAzimuth},ã€${highestElevation}ã€‘</td>
            <td>${exitTime}, ${exitAzimuth}</td>
        </tr>
    `;

});

html += `
    </tbody>
</table>
`;

return html;

}
    </script>
</body>
</html>
